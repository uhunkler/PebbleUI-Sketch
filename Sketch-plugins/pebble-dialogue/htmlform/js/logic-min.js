var de=de||{};de.unodo={conn:null,host:"ws://localhost:",port:9912,switcher:document.querySelector("#switcher"),rotateBtn:document.querySelector("#rotate-btn"),rotatorBtn:null,timepageBtn:null,generatepage:document.querySelector("#generate"),timepage:document.querySelector("#time"),btns:document.querySelector("#buttons"),settimeBtn:document.querySelector("#settime-btn"),addtimeBtn:document.querySelector("#addtime-btn"),runclockBtn:document.querySelector("#runclock-btn"),btn:document.querySelector("#calculate"),undoBtn:document.querySelector("#undo"),output:document.querySelector("#output"),fieldTable:document.querySelector("#fields"),fieldTableBody:null,templates:document.querySelector("#templates"),templatesRow:null,queryStrName:'[data-type="name"]',queryStrAngle:'[data-type="angle"]',runclockRunning:null},de.unodo.init=function(){this.connectWS(),this.fieldTableBody=this.fieldTable.querySelector("tbody"),this.templatesRow=this.templates.querySelector("table tr"),this.rotatorBtn=this.switcher.querySelector("#rotator-btn"),this.timepageBtn=this.switcher.querySelector("#time-btn"),document.addEventListener("submit",this.submitHandler,!1),document.addEventListener("focusin",this.focusinHandler,!1),this.switcher.addEventListener("click",this.switcherClickHandler,!1),this.rotateBtn.addEventListener("click",this.rotateSendHandler,!1),this.btn.addEventListener("click",this.rotateDupSendHandler,!1),this.undoBtn.addEventListener("click",this.undoSendHandler,!1),this.settimeBtn.addEventListener("click",this.settimeSendHandler,!1),this.addtimeBtn.addEventListener("click",this.addtimeSendHandler,!1),this.runclockBtn.addEventListener("click",this.runclockSendHandler,!1),this.fieldTable.addEventListener("click",this.tableClickHandler,!1),this.startMutationObserver(),this.generatepage.style.height=window.getComputedStyle(this.generatepage.querySelector(".wrap"),null).getPropertyValue("height"),this.rotatorBtn.className+=" pure-button-disabled"},de.unodo.connectWS=function(){this.conn=new WebSocket(this.host+this.port),this.conn.onopen=function(){de.unodo.rotateBtn.className=de.unodo.rotateBtn.className.replace(/\s*hidden\s*/,""),de.unodo.btns.className=de.unodo.btns.className.replace(/\s*hidden\s*/,""),de.unodo.settimeBtn.className=de.unodo.settimeBtn.className.replace(/\s*hidden\s*/,""),de.unodo.addtimeBtn.className=de.unodo.addtimeBtn.className.replace(/\s*hidden\s*/,""),de.unodo.runclockBtn.className=de.unodo.runclockBtn.className.replace(/\s*hidden\s*/,""),de.unodo.displayMessage("Connected to Sketch! "),de.unodo.generatepage.style.height=de.unodo.getInnerHeight(de.unodo.generatepage)},this.conn.onmessage=function(e){console.log(e.data),de.unodo.displayMessage(e.data)}},de.unodo.sendOnWS=function(e){3===this.conn.readyState?(this.conn=new WebSocket(this.host+this.port),this.conn.onopen=function(){this.conn.send(e)}):1===this.conn.readyState&&this.conn.send(e)},de.unodo.displayMessage=function(e){this.output.innerHTML=e},de.unodo.submitHandler=function(e){e.preventDefault()},de.unodo.focusinHandler=function(){de.unodo.runclockRunning&&de.unodo.runclockBtn.click()},de.unodo.displayFormValuesHandler=function(e){e.preventDefault();var t=de.unodo.getFormValues();de.unodo.output.innerHTML=JSON.stringify(t)},de.unodo.switcherClickHandler=function(e){e.preventDefault(),de.unodo.changePage(e.target.id)},de.unodo.changePage=function(e){switch(e){case"rotator-btn":de.unodo.generatepage.style.height=de.unodo.getInnerHeight(de.unodo.generatepage),de.unodo.timepage.style.height="0",-1===de.unodo.rotatorBtn.className.indexOf("pure-button-disabled")&&(de.unodo.rotatorBtn.className+=" pure-button-disabled"),de.unodo.timepageBtn.className=de.unodo.timepageBtn.className.replace(/\s*pure-button-disabled\s*/,"");break;case"time-btn":de.unodo.timepage.style.height=de.unodo.getInnerHeight(de.unodo.timepage),de.unodo.generatepage.style.height="0",-1===de.unodo.timepageBtn.className.indexOf("pure-button-disabled")&&(de.unodo.timepageBtn.className+=" pure-button-disabled"),de.unodo.rotatorBtn.className=de.unodo.rotatorBtn.className.replace(/\s*pure-button-disabled\s*/,"")}},de.unodo.getInnerHeight=function(e){return window.getComputedStyle(e.querySelector(".wrap"),null).getPropertyValue("height")},de.unodo.rotateSendHandler=function(e){e.preventDefault(),de.unodo.sendOnWS("[sketch:coscript] ../pebble-dialogue/rotate.jstalk")},de.unodo.rotateDupSendHandler=function(e){e.preventDefault(),de.unodo.sendOnWS("[sketch:coscript] ../pebble-dialogue/rotate-duplicate.jstalk")},de.unodo.undoSendHandler=function(e){e.preventDefault(),de.unodo.sendOnWS("[sketch:osascript] ../UI/sketch3_undo.scpt")},de.unodo.settimeSendHandler=function(e){e.preventDefault(),de.unodo.sendOnWS("[sketch:coscript] ../pebble-dialogue/settime.jstalk")},de.unodo.addtimeSendHandler=function(e){e.preventDefault();var t=de.unodo.addTime(document.querySelector("#settime").value,document.querySelector("#addtime").value);document.querySelector("#settime").value=t,de.unodo.sendOnWS("[sketch:coscript] ../pebble-dialogue/settime.jstalk")},de.unodo.runclockSendHandler=function(e){e.preventDefault(),de.unodo.runclockRunning?(clearTimeout(de.unodo.runclockRunning),de.unodo.runclockRunning=null,de.unodo.runclockBtn.textContent="Run"):(de.unodo.runclockBtn.textContent="Stop",de.unodo.runclockRunning=setTimeout(de.unodo.runclockRun,1))},de.unodo.runclockRun=function(){if(de.unodo.runclockRunning){var e=de.unodo.addTime(document.querySelector("#settime").value,document.querySelector("#addtime").value);document.querySelector("#settime").value=e,de.unodo.sendOnWS("[sketch:coscript] ../pebble-dialogue/settime.jstalk"),de.unodo.runclockRunning=setTimeout(de.unodo.runclockRun,1e3)}},de.unodo.tableClickHandler=function(e){e.preventDefault(),"button"===e.target.nodeName.toLowerCase()&&(-1!==e.target.id.indexOf("remove")?de.unodo.removeRow(e.target):-1!==e.target.id.indexOf("add")&&de.unodo.addRow(e.target))},de.unodo.removeRow=function(e){var t=/.*(\d{1,})/,n,o,d;d=e.id.match(t),d&&void 0!==d[1]&&(o=d[1],n=this.fieldTableBody.querySelector("#row"+o),n&&this.fieldTableBody.removeChild(n))},de.unodo.addRow=function(e){var t,n;n=this.templatesRow.cloneNode(!0),t=e.parentNode.parentNode,n.querySelector(this.queryStrName).value=t.querySelector(this.queryStrName).value,n.querySelector(this.queryStrAngle).value=t.querySelector(this.queryStrAngle).value,t.querySelector(this.queryStrName).value="",t.querySelector(this.queryStrAngle).value="",this.fieldTableBody.insertBefore(n,t)},de.unodo.renumberRows=function(){de.unodo.generatepage.style.height=de.unodo.getInnerHeight(de.unodo.generatepage);var e=this.fieldTableBody.querySelectorAll("tr"),t,n,o,d;for(d=e.length;d>=0;d--)t=e[d],void 0!==t&&(n=d+1,t.id="row"+n,t.querySelector(this.queryStrName).name="name"+n,t.querySelector(this.queryStrAngle).name="angle"+n,o=t.querySelector('[data-type="add"]'),o&&(o.id="add"+n),o=t.querySelector('[data-type="remove"]'),o&&(o.id="remove"+n))},de.unodo.getFormValues=function(){var e=this.fieldTableBody.querySelectorAll("tr"),t=[],n,o,d,r,u;for(r=0,u=e.length;u>=r;r++)n=e[r],void 0!==n&&(o=n.querySelector(this.queryStrName).value,d=n.querySelector(this.queryStrAngle).value,""!==o&&""!==d&&t.push({name:o,angle:parseInt(d,10)}));return t},de.unodo.returnRotateAngle=function(){return document.querySelector("#rotangle").value},de.unodo.returnSetTime=function(){return document.querySelector("#settime").value},de.unodo.returnDuplicateData=function(){var e=this.getFormValues();return JSON.stringify(e)},de.unodo.startMutationObserver=function(){var e=this.fieldTableBody,t=new MutationObserver(function(e){e.forEach(function(e){"childList"===e.type&&de.unodo.renumberRows()})}),n={childList:!0};t.observe(e,n)},de.unodo.addTime=function(e,t){var n=function(e){return(10>e?"0":"")+e},o,d,r,u,a,i,l;for(e=e.toString().split(/\D/)||[],t=t.toString().split(/\D/)||[],1===e.length&&""===e[0]&&(e=[]),l=3-e.length;l>0;l--)e.unshift(0);for(1===t.length&&""===t[0]&&(t=[]),l=3-t.length;l>0;l--)t.unshift(0);return o=60*parseInt(e[0],10)*60+60*parseInt(e[1],10)+parseInt(e[2],10),d=60*parseInt(t[0],10)*60+60*parseInt(t[1],10)+parseInt(t[2],10),r=o+d,u=Math.floor(r/60),r%=60,a=Math.floor(u/60),u%=60,i=Math.floor(a/24),a%=24,n(a)+":"+n(u)+":"+n(r)},de.unodo.init(),console.log("done");